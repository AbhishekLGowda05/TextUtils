"""Enhanced legacy Kannada to Unicode converter with OCR post-processing."""

import unicodedata
import re
from typing import Dict, List, Tuple

# Significantly expanded legacy Kannada mappings (Nudi/KGP/Baraha encodings)
LEGACY_TO_UNICODE = {
    # Vowels - Extended mappings
    "AiÀÄ": "ಆ",
    "ªÀ": "ಅ", 
    "EgÀ": "ಇ",
    "EgÀÄ": "ಈ",
    "GvÀÛ": "ಉ",
    "GvÀÛÄ": "ಊ",
    "F": "ಎ",
    "¥À": "ಏ",
    "AiÉÆ": "ಐ",
    "AiÀiÁ": "ಒ",
    "AiÀiÁÄ": "ಓ",
    "AiÀiï": "ಔ",
    
    # Additional vowel patterns found in your text
    "ಏೊ": "ಏ",
    "ೆV": "ೆ",
    "ಾಗU": "ಾಗ",
    "ೂ¹": "ೂ",
    "ಾÛ": "ಾ",
    "ೀÛ": "ೀ",
    "ೆU": "ೆ",
    "ಾ½": "ಾ",
    "ೀß": "ೀ",
    
    # Consonants - Common mappings
    "£À": "ನ",
    "PÀ": "ಡ",
    "gÀ": "ಗ",
    "µÀ": "ಮ",
    "zÀ": "ಜ",
    "dÄ": "ತ",
    "¸À": "ಸ",
    "¨sÀ": "ಹ",
    "®": "ಕ",
    "C": "ಚ",
    "r": "ರ",
    "¯À": "ಪ",
    "§": "ಲ",
    "ªÀiÁ": "ಯ",
    "ªÀÄ": "ವ",
    "²": "ಬ",
    "¢": "ಖ",
    
    # Extended consonant patterns from your text
    "ಗು": "ಗು",
    "ಮೊ": "ಮೊ",
    "ಡ": "ಡ",
    "ೀಜ": "ೀಜ",
    "ವಾ": "ವಾ",
    "MAಜ": "ಮಜ",
    "ಜA": "ಜ",
    "ºಾ": "ಸಾ",
    "ವಆ": "ವ",
    "ಸÛಡU": "ಸಂಡ",
    "ಾ¼ಾ": "ಾದಾ",
    "ಲU": "ಲ",
    "ೌ": "ೌ",
    "ೀR": "ೀರ",
    "åವA": "ಾವ",
    "æಆ": "ೆ",
    "ಅಗ": "ಅಗ",
    "ಚx": "ಚ",
    "ಾð": "ಾತ",
    "DVಗ": "ದ್ವಿಗ",
    "ಬæೂ": "ಬೊ",
    "ಜÝಗ": "ಜ್ಞಗ",
    "Áವಆ": "ಅವ",
    "åನ": "ಾನ",
    "ವä": "ವ",
    "ಗಲ": "ಗಲ",
    "ೆೆ": "ೆ",
    "ಮï": "ಮ",
    "nè": "ನೆ",
    "ದÕಗ": "ದಾಗ",
    "ಸೀ": "ಸೀ",
    "ಗಅಸ": "ಗಸ",
    "ಅ": "ಅ",
    "Wೆ": "ವೆ",
    "ುೂ": "ೂ",
    "ಮು": "ಮು",
    "ಯ": "ಯ",
    "ರಜ": "ರಜ",
    "ಗೀ": "ಗೀ",
    
    # Complex legacy patterns
    "sÁಮ": "ಸಮ",
    "ತಜè": "ತಜೆ",
    "Áಜ": "ಅಜ",
    "ಗಏರ": "ಗರ",
    "Dಾಆ": "ದಾ",
    "DನA": "ದನ",
    "ವಾಗ": "ವಾಗ",
    "ಬಡëತ": "ಬಡತ",
    "EÁಸ": "ಇಸ",
    "ೆಆೀ": "ೆೀ",
    "ವಾÛೆ": "ವಾೆ",
    "ೂವ": "ೂವ",
    "ಾಗUಾ": "ಾಗಾ",
    "ವಆಅಗ": "ವಅಗ",
    "ೆVನ": "ೆನ",
    "åÏೀ": "ಾೀ",
    "UÁV": "ದಿ",
    "ಗಅ¹": "ಗ",
    "ಖÁAಡ": "ಖಡ",
    "Dzೆ": "ದಿ",
    "ೂಾº": "ೂಸ",
    "ೆುಗ": "ೆಗ",
    "ರ¹ವ": "ರವ",
    "ಾೀ": "ಾ",
    "ಿಎ": "ಇ",
    "ಮಆª": "ಮ",
    "Áಗ": "ಅಗ",
    "ಯನಜA": "ಯನಜ",
    "qಾ": "ಗಾ",
    "ಡೊ": "ಡೊ",
    "ಲಾೀ": "ಲಾ",
    "ತªÁV": "ತ",
    "ಗಅವ": "ಗವ",
    "ಾªÁಜ": "ಾಜ",
    "ಅÅ": "ಅ",
    "zsಾ": "ಸಾ",
    "ಅðದಡ": "ಅದದ",
    "ಚüÁæ": "ಚೆ",
    "ಆU": "ಆ",
    
    # Matras (vowel signs) - Extended
    "À": "ಾ",
    "Ä": "ೀ", 
    "Æ": "ು",
    "Ã": "ೂ",
    "É": "ೆ",
    "Ê": "ೇ",
    "Ë": "ೈ",
    "Ì": "ೊ",
    "Í": "ೋ",
    "Î": "ೌ",
    "Ï": "್",  # Halanta/Virama
    
    # Additional matra patterns
    "ಾ¼": "ಾದ",
    "ೆ½": "ೆ",
    "ೀß": "ೀ",
    "ಾÛ": "ಾ",
    "ೂ¹": "ೂ",
    "ಅÅ": "ಅ",
    "ೆÂ": "ೆ",
    "ಾæ": "ಾ",
    "ೀà": "ೀ",
    "ಾå": "ಾ",
    "ೆè": "ೆ",
    "Uಾ": "ದಾ",
    "ವಾ": "ವಾ",
    "ಾA": "ಾ",
    
    # Numerals and symbols
    "೦": "೦", "೧": "೧", "೨": "೨", "೩": "೩", "೪": "೪",
    "೫": "೫", "೬": "೬", "೭": "೭", "೮": "೮", "೯": "೯",
    
    # Common OCR artifacts
    "ÁV": "",
    "Áಜ": "ಅಜ",
    "ÁV": "",
    "ೀß": "ೀ",
    "ಾ¼": "ಾದ",
    "ೆ½": "ೆ",
    "zೆ": "ಜೆ",
    "ಜÝ": "ಜ್ಞ",
    "ಕè": "ಕೆ",
    "zತ": "ಜತ",
    "ÁZ": "ಅ",
    "ೆU": "ೆ",
    "åÏ": "ಾ",
    "ರ¹": "ರ",
    "ಜA": "ಜ",
    "qಾ": "ಗಾ",
    "Áಗ": "ಅಗ",
    "ªÁ": "",
    "ÁV": "",
    "zೆ": "ಜೆ",
    "Ýೂ": "ೂ",
    "ªೆ": "ೆ",
    "ಅð": "ಅತ",
    "üÁ": "",
    "æÆ": "ೆ",
    "Åz": "",
    "ೆA": "ೆ",
    "Ezೆ": "ಇಜೆ",
    "åQ": "ಾ",
    "Û": "",
    "ಸé": "ಸೆ",
    "Æ": "ು",
    "Aೆ": "ೆ",
    "æೂ": "ೊ",
    "zೆ": "ಜೆ",
    "ುೂ": "ೂ",
    "Æ": "ು",
    "AೆÜ": "ೆ",
    "ಸA": "ಸ",
    "Wಾ": "ವಾ",
    "Pೆ": "ಪೆ",
    "ೊಡ": "ೊಡ",
    "¼ಾ": "ದಾ",
    "ೀ¹": "ೀ",
    "ಜÝಗ": "ಜ್ಞಗ",
    "ಏಜ": "ಏಜ",
    "ಬೂ": "ಬೂ",
    "ಕೆ": "ಕೆ",
    "ಯರ": "ಯರ",
    "ಜÝಕ": "ಜ್ಞಕ",
    "èz": "ೆ",
    "ತೆ": "ತೆ",
    "ÁZ": "ಅ",
    "ೆU": "ೆ",
    "ೊ": "ೊ",
    "ಸA": "ಸ",
    "ªÁಜ": "ಜ",
    "Kಏ": "ಕ",
    "ðರ": "ತರ",
    "¹Z": "",
    "Áಗ": "ಅಗ",
    "ವಆ": "ವ",
    "ಯರP": "ಯರಪ",
    "ೆುA": "ೆ",
    "ರz": "ರಜ",
    "ೆÝೂ": "ೊ",
    "ªೆೆ": "ೆ",
    "Áæx": "ಅ",
    "ಾಾೀ": "ಾ",
    "ವವಾ": "ವಾ",
    "ೈæq": "ೈ",
    "sಾÁÁ": "ಸಾ",
    "ಚzs": "ಚಸ",
    "Áå": "ಅ",
    "ಜU": "ಜ",
    "ೂರ": "ೂರ",
    "ಚü": "ಚ",
    "Áæ": "ಅ",
    "Æ": "ು",
    "ಸAU": "ಸ",
    "ಾæಸ": "ಾಸ",
    "ÁVz": "",
    "ೆ": "ೆ",
}

# Enhanced OCR misrecognitions for Kannada
OCR_CORRECTIONS = {
    # Common Tesseract misrecognitions
    "0": "೦", "1": "೧", "2": "೨", "3": "೩", "4": "೪",
    "5": "೫", "6": "೬", "7": "೭", "8": "೮", "9": "೯",
    
    # Character confusions from your sample
    "o": "ೊ", "O": "ಒ", "e": "ೆ", "u": "ು", "i": "ಿ", "a": "ಅ",
    "|": "ಲ್", "l": "ಲ", "I": "ಇ", "S": "ಸ", "m": "ಮ", "n": "ನ",
    "r": "ರ", "t": "ತ", "d": "ದ", "p": "ಪ", "b": "ಬ", "k": "ಕ",
    "g": "ಗ", "j": "ಜ", "c": "ಚ", "h": "ಹ", "y": "ಯ", "v": "ವ", "w": "ವ",
    
    # Symbol corrections
    "Á": "", "ಾ¼": "ಾದ", "ೀß": "ೀ", "ೆ½": "ೆ", "ಾÛ": "ಾ",
    "ೂ¹": "ೂ", "ಜÝ": "ಜ್ಞ", "zೆ": "ಜೆ", "ÁV": "", "ªÁ": "",
    "ೀà": "ೀ", "ಾå": "ಾ", "ೆè": "ೆ", "Uಾ": "ದಾ", "ಾA": "ಾ",
    "qಾ": "ಗಾ", "åಏ": "ಾ", "ಸÛ": "ಸಂ", "¼ಾ": "ದಾ", "ೀ¹": "ೀ",
    "ಜA": "ಜ", "ವA": "ವ", "æÆ": "ೆ", "üÁ": "", "Åz": "",
    
    # Complex patterns
    "MAಜ": "ಮಜ", "DVಗ": "ದ್ವಿಗ", "ಬæೂ": "ಬೊ", "ಜÝಗ": "ಜ್ಞಗ",
    "ದÕಗ": "ದಾಗ", "ಸÛಡ": "ಸಂಡ", "zsಾ": "ಸಾ", "ಚzs": "ಚಸ",
    "DನA": "ದನ", "ಬಡëತ": "ಬಡತ", "EÁಸ": "ಇಸ", "ಗಏರ": "ಗರ",
    "ಖÁA": "ಖ", "Dzೆ": "ದಿ", "ೂಾº": "ೂಸ", "ರ¹ವ": "ರವ",
    "ಮಆª": "ಮ", "ಡೊ": "ಡೊ", "ತªÁ": "ತ", "ಾªÁ": "ಾ",
}

# ...existing code for ranges, functions etc. remains the same...

def clean_ocr_artifacts(text: str) -> str:
    """Enhanced cleaning for complex OCR artifacts."""
    # Remove multiple spaces
    text = re.sub(r'\s+', ' ', text)
    
    # Remove isolated punctuation marks
    text = re.sub(r'\s+[.,:;!?]\s+', ' ', text)
    
    # Fix broken word boundaries - more conservative approach
    text = re.sub(r'([ಕ-ೞ])([ಕ-ೞ])', r'\1 \2', text)
    
    # Remove common OCR artifacts
    artifacts = ['Á', 'ß', '¼', '½', '¹', 'Û', 'Ý', 'æ', 'ü', 'ð', 'è', 'å', 'ë']
    for artifact in artifacts:
        text = text.replace(artifact, '')
    
    # Remove non-printable characters except Kannada joiners
    text = re.sub(r'[^\u0C80-\u0CFF\u200C\u200D\s\w.,!?;:()\-೦-೯]', '', text)
    
    # Fix common spacing issues
    text = re.sub(r'([ಕ-ೞ])([೦-೯])', r'\1 \2', text)  # Add space between letter and number
    text = re.sub(r'([೦-೯])([ಕ-ೞ])', r'\1 \2', text)  # Add space between number and letter
    
    return text.strip()

# ...rest of the existing functions remain the same...